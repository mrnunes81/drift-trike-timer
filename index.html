<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciador de Drift Trikes</title>
  <link href="./src/output.css" rel="stylesheet" />
  <!-- Firebase v9 modular -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      push,
      update,
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDizfkzSJMXyY30M1hHTkxZ8PZjrMZtMmU",
      authDomain: "drift-trike-timer.firebaseapp.com",
      databaseURL: "https://drift-trike-timer-default-rtdb.firebaseio.com",
      projectId: "drift-trike-timer",
      storageBucket: "drift-trike-timer.firebasestorage.app",
      messagingSenderId: "904950542869",
      appId: "1:904950542869:web:ec2d83299243aa6e82141c",
    };

    // Inicializa Firebase e Database
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const RATE_PER_10_MIN = 20;

    // Estado dos triciclos
    const trikes = Array.from({ length: 10 }, (_, i) => ({
      id: i + 1,
      timer: null,
      timeLeft: 0,
      isRunning: false,
    }));

    // Elementos do DOM
    const totalSessions = document.getElementById("totalSessions");
    const totalValue = document.getElementById("totalValue");
    const totalDiscount = document.getElementById("totalDiscount");
    const finalTotalValue = document.getElementById("finalTotalValue");
    const trikesContainer = document.getElementById("trikesContainer");

    // Formata segundos em mm:ss
    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return `${min.toString().padStart(2, "0")}:${sec.toString().padStart(2, "0")}`;
    }

    // Calcula valor conforme minutos
    function calculateValue(minutes) {
      return (minutes / 10) * RATE_PER_10_MIN;
    }

    // Toca alerta sonoro e mostra alerta visual
    function playAlert() {
      const audio = new Audio("https://www.soundjay.com/buttons/beep-01a.mp3");
      audio.play();
      alert("Tempo esgotado!");
    }

    // Atualiza relatório do dia
    function updateReport() {
      const sessionsRef = ref(database, "sessions");
      onValue(
        sessionsRef,
        (snapshot) => {
          const sessions = snapshot.val() ? Object.values(snapshot.val()) : [];
          const total = sessions.reduce((acc, s) => acc + (s.value || 0), 0);
          const totalDisc = sessions.reduce((acc, s) => acc + (s.discount || 0), 0);
          totalSessions.textContent = sessions.length;
          totalValue.textContent = total.toFixed(2);
          totalDiscount.textContent = totalDisc.toFixed(2);
          finalTotalValue.textContent = (total - totalDisc).toFixed(2);
        },
        { onlyOnce: true }
      );
    }

    // Atualiza UI de um trike conforme status
    function updateTrikeUI(trikeId) {
      const trike = trikes[trikeId - 1];
      const trikeElement = document.getElementById(`trike-${trikeId}`);
      if (!trikeElement) return;

      const btn10min = trikeElement.querySelector(`#btn10min-${trikeId}`);
      const btn20min = trikeElement.querySelector(`#btn20min-${trikeId}`);
      const startBtn = trikeElement.querySelector(`#startTimer-${trikeId}`);
      const renewBtn = trikeElement.querySelector(`#renewTimer-${trikeId}`);
      const timerStatus = trikeElement.querySelector(`#timerStatus-${trikeId}`);

      const isRunning = trike.isRunning;

      const activeClass = isRunning ? "bg-red-500 hover:bg-red-600" : "bg-green-500 hover:bg-green-600";

      btn10min.className = `flex-1 ${activeClass} text-white py-2 rounded`;
      btn20min.className = `flex-1 ${activeClass} text-white py-2 rounded`;
      startBtn.textContent = isRunning ? "Em Uso" : "Iniciar";
      startBtn.disabled = isRunning;
      renewBtn.classList.toggle("hidden", !isRunning);
      timerStatus.classList.toggle("hidden", !isRunning);
    }

    // Inicia contagem regressiva para um trike
    function startCountdown(trikeId, minutes) {
      const trike = trikes[trikeId - 1];
      if (trike.timer) clearInterval(trike.timer);

      trike.timeLeft = minutes * 60;
      trike.isRunning = true;

      const trikeElement = document.getElementById(`trike-${trikeId}`);
      const discountInput = trikeElement.querySelector(`#discount-${trikeId}`);
      const paymentStatus = trikeElement.querySelector(`#paymentStatus-${trikeId}`);
      const timeRemaining = trikeElement.querySelector(`#timeRemaining-${trikeId}`);
      const currentValue = trikeElement.querySelector(`#currentValue-${trikeId}`);
      const currentDiscount = trikeElement.querySelector(`#currentDiscount-${trikeId}`);
      const finalValue = trikeElement.querySelector(`#finalValue-${trikeId}`);
      const currentPaymentStatus = trikeElement.querySelector(`#currentPaymentStatus-${trikeId}`);

      const value = calculateValue(minutes);
      const discount = parseFloat(discountInput.value) || 0;
      const final = Math.max(value - discount, 0);

      // Atualiza display
      currentValue.textContent = value.toFixed(2);
      currentDiscount.textContent = discount.toFixed(2);
      finalValue.textContent = final.toFixed(2);
      currentPaymentStatus.textContent = paymentStatus.value === "pago" ? "Pago" : "Não Pago";
      timeRemaining.textContent = formatTime(trike.timeLeft);

      // Atualiza Firebase
      set(ref(database, `trikes/${trikeId}`), {
        timeLeft: trike.timeLeft,
        isRunning: true,
        value,
        discount,
        finalValue: final,
        paymentStatus: paymentStatus.value,
      });

      // Contagem regressiva
      trike.timer = setInterval(() => {
        trike.timeLeft--;
        if (trike.timeLeft < 0) {
          clearInterval(trike.timer);
          trike.isRunning = false;
          playAlert();

          // Atualiza Firebase com status final
          set(ref(database, `trikes/${trikeId}`), {
            timeLeft: 0,
            isRunning: false,
            value,
            discount,
            finalValue: final,
            paymentStatus: paymentStatus.value,
          });

          // Salva sessão no histórico
          push(ref(database, "sessions"), {
            trikeId,
            minutes,
            value,
            discount,
            finalValue: final,
            paymentStatus: paymentStatus.value,
            timestamp: Date.now(),
          });

          updateReport();
          updateTrikeUI(trikeId);
          return;
        }

        // Atualiza tempo restante no DOM e no Firebase
        timeRemaining.textContent = formatTime(trike.timeLeft);
        update(ref(database, `trikes/${trikeId}`), { timeLeft: trike.timeLeft });
      }, 1000);

      updateTrikeUI(trikeId);
    }

    // Cria interface de um trike no DOM
    function createTrikeUI(trikeId) {
      const div = document.createElement("div");
      div.id = `trike-${trikeId}`;
      div.className = "bg-white p-4 rounded-lg shadow-md mb-4";

      div.innerHTML = `
        <h3 class="text-lg font-semibold mb-2">Drift Trike ${trikeId}</h3>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Selecionar Tempo</label>
          <div class="flex space-x-2 mt-2">
            <button id="btn10min-${trikeId}" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">10 Min</button>
            <button id="btn20min-${trikeId}" class="flex-1 bg-green-500 text-white py-2 rounded hover:bg-green-600">20 Min</button>
          </div>
          <input id="customTime-${trikeId}" type="number" min="1" placeholder="Tempo personalizado (min)" class="mt-2 w-full border border-gray-300 rounded p-2 text-sm" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Desconto (R$)</label>
          <input id="discount-${trikeId}" type="number" min="0" step="0.01" placeholder="0.00" class="w-full border border-gray-300 rounded p-2 text-sm" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Status de Pagamento</label>
          <select id="paymentStatus-${trikeId}" class="w-full border border-gray-300 rounded p-2 text-sm">
            <option value="pago">Pago</option>
            <option value="nao_pago">Não Pago</option>
          </select>
        </div>
        <button id="startTimer-${trikeId}" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Iniciar</button>
        <button id="renewTimer-${trikeId}" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600 mt-2 hidden">Renovar Tempo</button>
        <div id="timerStatus-${trikeId}" class="hidden mt-4">
          <p class="text-lg font-semibold">Tempo Restante: <span id="timeRemaining-${trikeId}">00:00</span></p>
          <p>Valor: R$ <span id="currentValue-${trikeId}">0.00</span></p>
          <p>Desconto: R$ <span id="currentDiscount-${trikeId}">0.00</span></p>
          <p>Valor Final: R$ <span id="finalValue-${trikeId}">0.00</span></p>
          <p>Status: <span id="currentPaymentStatus-${trikeId}">Não Pago</span></p>
        </div>
      `;

      trikesContainer.appendChild(div);

      // Eventos
      div.querySelector(`#btn10min-${trikeId}`).addEventListener("click", () => {
        div.querySelector(`#customTime-${trikeId}`).value = 10;
      });

      div.querySelector(`#btn20min-${trikeId}`).addEventListener("click", () => {
        div.querySelector(`#customTime-${trikeId}`).value = 20;
      });

      div.querySelector(`#startTimer-${trikeId}`).addEventListener("click", () => {
        const minutes = parseInt(div.querySelector(`#customTime-${trikeId}`).value);
        if (minutes > 0) startCountdown(trikeId, minutes);
        else alert("Por favor, insira um tempo válido maior que zero.");
      });

      div.querySelector(`#renewTimer-${trikeId}`).addEventListener("click", () => {
        const minutes = parseInt(div.querySelector(`#customTime-${trikeId}`).value);
        if (minutes > 0) startCountdown(trikeId, minutes);
        else alert("Por favor, insira um tempo válido maior que zero.");
      });
    }

    // Inicialização da aplicação
    function init() {
      // Cria UI para todos os triciclos
      for (let i = 1; i <= 10; i++) {
        createTrikeUI(i);
      }
      // Atualiza relatório inicial
      updateReport();
    }

    // Start app
    window.onload = init;
  </script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-3xl font-bold mb-6">Controle de Drift Trikes</h1>
  <div id="trikesContainer"></div>

  <div class="mt-8 p-4 bg-white rounded shadow-md">
    <h2 class="text-xl font-semibold mb-4">Relatório Diário</h2>
    <p>Total de Sessões: <span id="totalSessions">0</span></p>
    <p>Valor Total: R$ <span id="totalValue">0.00</span></p>
    <p>Total de Descontos: R$ <span id="totalDiscount">0.00</span></p>
    <p>Valor Final: R$ <span id="finalTotalValue">0.00</span></p>
  </div>
</body>
</html>
