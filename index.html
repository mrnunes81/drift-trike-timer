
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Drift Trike - Temporizador</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      font-family: sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .trike {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .trike h2 {
      margin: 0 0 10px;
    }
    .controls {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .time {
      font-size: 1.5em;
      font-weight: bold;
      margin: 10px 0;
    }
    .status {
      margin-top: 10px;
    }
    .pago-info {
      margin-top: 5px;
    }
    .green {
      background: #28a745;
      color: white;
    }
    .red {
      background: #dc3545;
      color: white;
    }
    .gray {
      background: #6c757d;
      color: white;
    }
    #relatorio {
      margin-top: 20px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Controle de Tempo - Drift Trikes</h1>
  <div id="trikes"></div>
  <div id="relatorio">
    <button onclick="gerarRelatorio()">Gerar Relatório do Dia</button>
    <div id="resultadoRelatorio"></div>
  </div>
  <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

  <!-- Firebase SDKs -->
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      update,
      get,
      child,
      off
    } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-database.js";

    // Firebase config (seu config)
    const firebaseConfig = {
      apiKey: "AIzaSyDizfkzSJMXyY30M1hHTkxZ8PZjrMZtMmU",
      authDomain: "drift-trike-timer.firebaseapp.com",
      databaseURL: "https://drift-trike-timer-default-rtdb.firebaseio.com",
      projectId: "drift-trike-timer",
      storageBucket: "drift-trike-timer.firebasestorage.app",
      messagingSenderId: "904950542869",
      appId: "1:904950542869:web:ec2d83299243aa6e82141c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const trikeCount = 10;
    const trikesContainer = document.getElementById("trikes");
    const faturamento = Array(trikeCount).fill(0);

    // Função para formatar tempo em mm:ss
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    // Criar cada trike com sincronização Firebase
    function createTrike(index) {
      const container = document.createElement("div");
      container.className = "trike";

      const title = document.createElement("h2");
      title.textContent = `Trike ${index + 1}`;

      const timeDisplay = document.createElement("div");
      timeDisplay.className = "time";
      timeDisplay.textContent = "00:00";

      let timer = null;
      let emUso = false;

      // Controles
      const controls = document.createElement("div");
      controls.className = "controls";

      // Botão fixo 10 min
      const fixedBtn10 = document.createElement("button");
      fixedBtn10.textContent = "10 min";
      fixedBtn10.className = "gray";
      controls.appendChild(fixedBtn10);

      // Botão fixo 20 min
      const fixedBtn20 = document.createElement("button");
      fixedBtn20.textContent = "20 min";
      fixedBtn20.className = "gray";
      controls.appendChild(fixedBtn20);

      // Input personalizado
      const personalInput = document.createElement("input");
      personalInput.type = "number";
      personalInput.placeholder = "Minutos";
      personalInput.min = "1";
      controls.appendChild(personalInput);

      // Botão renovar tempo
      const renewBtn = document.createElement("button");
      renewBtn.textContent = "Renovar Tempo";
      renewBtn.className = "gray";
      controls.appendChild(renewBtn);

      // Botão iniciar
      const startBtn = document.createElement("button");
      startBtn.textContent = "Iniciar";
      startBtn.className = "green";
      controls.appendChild(startBtn);

      // Botão pausar
      const pauseBtn = document.createElement("button");
      pauseBtn.textContent = "Pausar";
      pauseBtn.className = "gray";
      controls.appendChild(pauseBtn);

      // Botão resetar
      const resetBtn = document.createElement("button");
      resetBtn.textContent = "Resetar";
      resetBtn.className = "gray";
      controls.appendChild(resetBtn);

      // Status - pago, valor, desconto
      const statusDiv = document.createElement("div");
      statusDiv.className = "status";

      const pagoSelect = document.createElement("select");
      pagoSelect.add(new Option("Não Pago", "nao"));
      pagoSelect.add(new Option("Pago", "sim"));

      const valorInput = document.createElement("input");
      valorInput.type = "number";
      valorInput.placeholder = "Valor (R$)";
      valorInput.min = "0";
      valorInput.className = "pago-info";

      const descontoInput = document.createElement("input");
      descontoInput.type = "number";
      descontoInput.placeholder = "Desconto (R$)";
      descontoInput.min = "0";
      descontoInput.className = "pago-info";

      statusDiv.appendChild(pagoSelect);
      statusDiv.appendChild(valorInput);
      statusDiv.appendChild(descontoInput);

      container.appendChild(title);
      container.appendChild(timeDisplay);
      container.appendChild(controls);
      container.appendChild(statusDiv);
      trikesContainer.appendChild(container);

      // Variáveis de controle
      let remainingTime = 0;
      let totalTime = 0;

      // Firebase DB referência para este trike
      const trikeRef = ref(db, `trikes/trike${index}`);

      // Atualizar display de tempo
      function updateDisplay() {
        timeDisplay.textContent = formatTime(remainingTime);
      }

      // Função para salvar estado no Firebase
      function salvarEstadoFirebase() {
        set(trikeRef, {
          remainingTime,
          totalTime,
          emUso,
          pago: pagoSelect.value,
          valor: parseFloat(valorInput.value) || 0,
          desconto: parseFloat(descontoInput.value) || 0,
        });
      }

      // Iniciar timer local e salvar no Firebase
      function startTimer() {
        if (timer || remainingTime <= 0) return;
        emUso = true;
        salvarEstadoFirebase();
        timer = setInterval(() => {
          if (remainingTime > 0) {
            remainingTime--;
            updateDisplay();
            salvarEstadoFirebase();
          } else {
            clearInterval(timer);
            timer = null;
            emUso = false;
            updateDisplay();
            salvarEstadoFirebase();
            document.getElementById("alertSound").play();
            alert(`Tempo esgotado para o Trike ${index + 1}!`);
          }
        }, 1000);
      }

      function pauseTimer() {
        if (timer) {
          clearInterval(timer);
          timer = null;
          emUso = false;
          salvarEstadoFirebase();
        }
      }

      function resetTimer() {
        pauseTimer();
        remainingTime = 0;
        totalTime = 0;
        emUso = false;
        updateDisplay();
        salvarEstadoFirebase();
      }

      function setFixedTime(minutos) {
        pauseTimer();
        remainingTime = minutos * 60;
        totalTime = minutos * 60;
        updateDisplay();
        salvarEstadoFirebase();
      }

      function renewTime() {
        const minRenew = parseInt(personalInput.value || "0");
        if (minRenew > 0) {
          remainingTime += minRenew * 60;
          totalTime += minRenew * 60;
          updateDisplay();
          salvarEstadoFirebase();
        }
      }

      // Eventos botões
      fixedBtn10.onclick = () => setFixedTime(10);
      fixedBtn20.onclick = () => setFixedTime(20);
      renewBtn.onclick = renewTime;
      startBtn.onclick = startTimer;
      pauseBtn.onclick = pauseTimer;
      resetBtn.onclick = resetTimer;

      // Eventos inputs status para salvar no Firebase
      pagoSelect.onchange = salvarEstadoFirebase;
      valorInput.oninput = salvarEstadoFirebase;
      descontoInput.oninput = salvarEstadoFirebase;

      // Escutar alterações no Firebase e atualizar UI local
      onValue(trikeRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          remainingTime = data.remainingTime || 0;
          totalTime = data.totalTime || 0;
          emUso = data.emUso || false;

          // Atualiza campos UI
          pagoSelect.value = data.pago || "nao";
          valorInput.value = data.valor != null ? data.valor : "";
          descontoInput.value = data.desconto != null ? data.desconto : "";

          updateDisplay();

          // Se o timer está em uso e timer local não está rodando, iniciar local
          if (emUso && !timer) {
            startTimer();
          } else if (!emUso && timer) {
            pauseTimer();
          }
        } else {
          // Sem dados no firebase, reset local
          resetTimer();
        }
      });
    }

    // Gera relatório somando valores - desconto
    function gerarRelatorio() {
      let totalFaturado = 0;
      // Pega todos os dados no DB para somar
      const dbRef = ref(db, "trikes");
      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          for (const key in data) {
            if (data.hasOwnProperty(key)) {
              const trike = data[key];
              const valor = trike.valor || 0;
              const desconto = trike.desconto || 0;
              totalFaturado += Math.max(0, valor - desconto);
            }
          }
          document.getElementById(
            "resultadoRelatorio"
          ).textContent = `Total Faturado: R$ ${totalFaturado.toFixed(2)}`;
        } else {
          document.getElementById("resultadoRelatorio").textContent =
            "Nenhum dado disponível";
        }
      });
    }

    // Cria UI dos trikes
    for (let i = 0; i < trikeCount; i++) {
      createTrike(i);
    }
  </script>
</body>
</html>
