<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Drift Trike Timer - Sincronizado</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 10px;
    max-width: 900px;
    margin: auto;
  }
  .trike {
    border: 1px solid #ccc;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 6px;
  }
  .trike h3 {
    margin-top: 0;
  }
  label {
    display: inline-block;
    margin-right: 10px;
  }
  select, input[type=number] {
    width: 90px;
  }
  button {
    margin: 3px 6px 3px 0;
    padding: 6px 12px;
  }
  .status-paid {
    color: green;
    font-weight: bold;
  }
  .status-notpaid {
    color: red;
    font-weight: bold;
  }
  #relatorio {
    margin-top: 25px;
    border-top: 2px solid #333;
    padding-top: 12px;
  }
  #relatorio table {
    border-collapse: collapse;
    width: 100%;
  }
  #relatorio th, #relatorio td {
    border: 1px solid #ddd;
    padding: 8px;
  }
  #relatorio th {
    background: #eee;
  }
</style>
</head>
<body>

<h1>Drift Trike Timer - Sincronizado</h1>

<div id="trikesContainer"></div>

<button id="btnShowReport">Mostrar Relatório do Dia</button>

<div id="relatorio" style="display:none;">
  <h2>Relatório Diário</h2>
  <table>
    <thead>
      <tr>
        <th>Trike</th>
        <th>Tempo Usado</th>
        <th>Pago?</th>
        <th>Desconto (R$)</th>
        <th>Valor Final (R$)</th>
      </tr>
    </thead>
    <tbody id="relatorioBody"></tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Config Firebase - substitua pelos seus dados!
const firebaseConfig = {
  apiKey: "AIzaSyDizfkzSJMXyY30M1hHTkxZ8PZjrMZtMmU",
  authDomain: "drift-trike-timer.firebaseapp.com",
  databaseURL: "https://drift-trike-timer-default-rtdb.firebaseio.com",
  projectId: "drift-trike-timer",
  storageBucket: "drift-trike-timer.appspot.com",
  messagingSenderId: "904950542869",
  appId: "1:904950542869:web:ec2d83299243aa6e82141c"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const PERIODO_MINUTOS = 10;
const VALOR_POR_10MIN = 20;
const TRIKES_TOTAL = 10;

function formatTime(segundos) {
  const m = Math.floor(segundos / 60);
  const s = segundos % 60;
  return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

const trikes = [];

function criarTrikeObjeto(id) {
  return {
    id: id,
    timeLeft: 0,
    isRunning: false,
    isPaused: false,
    timer: null,
    discount: 0,
    paymentStatus: 'nao_pago', // ou 'pago'
    value: 0,
    finalValue: 0,
  };
}

function calcularValores(trike) {
  // Valor base = (tempo usado em segundos / 600 segundos) * 20 reais
  let minutosUsados = (PERIODO_MINUTOS * Math.ceil(trike.timeLeft / (PERIODO_MINUTOS * 60))) || 0;
  let valor = ((PERIODO_MINUTOS * 60 - trike.timeLeft) / 600) * VALOR_POR_10MIN;
  if (valor < 0) valor = 0;
  trike.value = valor;
  trike.finalValue = Math.max(0, valor - trike.discount);
}

function criarUITrike(trike) {
  const container = document.createElement('div');
  container.className = 'trike';
  container.id = `trike-${trike.id}`;

  container.innerHTML = `
    <h3>Trike #${trike.id}</h3>
    <label>Tempo personalizado (min): 
      <input type="number" id="customTime-${trike.id}" min="1" max="120" value="10" />
    </label>
    <br/>
    <label>Tempo restante: <span id="timeRemaining-${trike.id}">00:00</span></label>
    <br/>
    <button id="btnStart-${trike.id}">Iniciar</button>
    <button id="btnPause-${trike.id}" disabled>Pausar</button>
    <button id="btnResume-${trike.id}" disabled>Retomar</button>
    <button id="btnReset-${trike.id}">Resetar</button>
    <br/><br/>
    <label>Desconto (R$): <input type="number" id="discount-${trike.id}" min="0" step="0.01" value="0" /></label>
    <br/>
    <label>Pagamento: 
      <select id="paymentStatus-${trike.id}">
        <option value="nao_pago">Não Pago</option>
        <option value="pago">Pago</option>
      </select>
    </label>
    <br/><br/>
    <div>
      Valor: R$ <span id="currentValue-${trike.id}">0.00</span><br/>
      Desconto: R$ <span id="currentDiscount-${trike.id}">0.00</span><br/>
      Valor Final: R$ <span id="finalValue-${trike.id}">0.00</span><br/>
      Status Pagamento: <span id="currentPaymentStatus-${trike.id}" class="status-notpaid">Não Pago</span>
    </div>
  `;

  document.getElementById('trikesContainer').appendChild(container);

  // Eventos dos botões e inputs:
  document.getElementById(`btnStart-${trike.id}`).addEventListener('click', () => iniciarTrike(trike.id));
  document.getElementById(`btnPause-${trike.id}`).addEventListener('click', () => pausarTrike(trike.id));
  document.getElementById(`btnResume-${trike.id}`).addEventListener('click', () => retomarTrike(trike.id));
  document.getElementById(`btnReset-${trike.id}`).addEventListener('click`, () => resetarTrike(trike.id));

  document.getElementById(`customTime-${trike.id}`).addEventListener('change', (e) => {
    let val = parseInt(e.target.value);
    if (val < 1) val = 1;
    else if (val > 120) val = 120;
    e.target.value = val;
    // Atualiza o tempo restante no local e Firebase somente se timer não estiver rodando
    if (!trike.isRunning) {
      trike.timeLeft = val * 60;
      atualizarFirebase(trike.id, { timeLeft: trike.timeLeft });
    }
  });

  document.getElementById(`discount-${trike.id}`).addEventListener('change', (e) => {
    let desconto = parseFloat(e.target.value);
    if (isNaN(desconto) || desconto < 0) desconto = 0;
    trike.discount = desconto;
    calcularValores(trike);
    atualizarFirebase(trike.id, {
      discount: trike.discount,
      finalValue: trike.finalValue,
      value: trike.value,
    });
    atualizarUIValores(trike.id);
  });

  document.getElementById(`paymentStatus-${trike.id}`).addEventListener('change', (e) => {
    trike.paymentStatus = e.target.value;
    atualizarFirebase(trike.id, { paymentStatus: trike.paymentStatus });
    atualizarUIValores(trike.id);
  });
}

function atualizarUIValores(id) {
  const trike = trikes[id - 1];
  const trikeElement = document.getElementById(`trike-${id}`);
  if (!trikeElement) return;

  trikeElement.querySelector(`#currentValue-${id}`).textContent = trike.value.toFixed(2);
  trikeElement.querySelector(`#currentDiscount-${id}`).textContent = trike.discount.toFixed(2);
  trikeElement.querySelector(`#finalValue-${id}`).textContent = trike.finalValue.toFixed(2);

  const statusEl = trikeElement.querySelector(`#currentPaymentStatus-${id}`);
  if (trike.paymentStatus === 'pago') {
    statusEl.textContent = 'Pago';
    statusEl.classList.add('status-paid');
    statusEl.classList.remove('status-notpaid');
  } else {
    statusEl.textContent = 'Não Pago';
    statusEl.classList.add('status-notpaid');
    statusEl.classList.remove('status-paid');
  }
}

function atualizarFirebase(id, dados) {
  database.ref(`trikes/${id}`).update(dados);
}

function iniciarTrike(id) {
  const trike = trikes[id - 1];
  if (trike.isRunning) return;

  // Se o tempo restante for 0, pega do tempo personalizado
  if (trike.timeLeft <= 0) {
    const valMin = parseInt(document.getElementById(`customTime-${id}`).value);
    trike.timeLeft = valMin * 60;
  }

  trike.isRunning = true;
  trike.isPaused = false;

  // Atualiza Firebase
  atualizarFirebase(id, {
    timeLeft: trike.timeLeft,
    isRunning: true,
    isPaused: false,
  });

  iniciarContagem(id);
  updateTrikeUI(id);
}

function iniciarContagem(id) {
  const trike = trikes[id - 1];
  const trikeElement = document.getElementById(`trike-${id}`);

  if (trike.timer) clearInterval(trike.timer);

  trike.timer = setInterval(() => {
    if (trike.isPaused || !trike.isRunning) return;

    if (trike.timeLeft <= 0) {
      clearInterval(trike.timer);
      trike.isRunning = false;
      trike.isPaused = false;
      alert(`Tempo do trike #${id} acabou!`);
      updateTrikeUI(id);
      // Atualiza Firebase
      atualizarFirebase(id, {
        timeLeft: 0,
        isRunning: false,
        isPaused: false,
      });
      return;
    }
    trike.timeLeft--;
    // Atualiza UI
    trikeElement.querySelector(`#timeRemaining-${id}`).textContent = formatTime(trike.timeLeft);

    calcularValores(trike);
    atualizarFirebase(id, {
      timeLeft: trike.timeLeft,
      value: trike.value,
      finalValue: trike.finalValue
    });
    atualizarUIValores(id);
  }, 1000);
}

function pausarTrike(id) {
  const trike = trikes[id - 1];
  if (!trike.isRunning || trike.isPaused) return;

  trike.isPaused = true;
  atualizarFirebase(id, { isPaused: true });
  updateTrikeUI(id);
}

function retomarTrike(id) {
  const trike = trikes[id - 1];
  if (!trike.isRunning || !trike.isPaused) return;

  trike.isPaused = false;
  atualizarFirebase(id, { isPaused: false });
  updateTrikeUI(id);
}

function resetarTrike(id) {
  const trike = trikes[id - 1];
  if (trike.timer) clearInterval(trike.timer);

  trike.isRunning = false;
  trike.isPaused = false;
  trike.timeLeft = 0;
  trike.discount = 0;
  trike.paymentStatus = 'nao_pago';
  trike.value = 0;
  trike.finalValue = 0;

  // Reset inputs UI
  const trikeElement = document.getElementById(`trike-${id}`);
  trikeElement.querySelector(`#customTime-${id}`).value = 10;
  trikeElement.querySelector(`#timeRemaining-${id}`).textContent = '00:00';
  trikeElement.querySelector(`#discount-${id}`).value = 0;
  trikeElement.querySelector(`#paymentStatus-${id}`).value = 'nao_pago';

  atualizarFirebase(id, {
    timeLeft: 0,
    isRunning: false,
    isPaused: false,
    discount: 0,
    paymentStatus: 'nao_pago',
    value: 0,
    finalValue: 0,
  });

  atualizarUIValores(id);
  updateTrikeUI(id);
}

function updateTrikeUI(id) {
  const trike = trikes[id - 1];
  const trikeElement = document.getElementById(`trike-${id}`);
  if (!trikeElement) return;

  const btnStart = trikeElement.querySelector(`#btnStart-${id}`);
  const btnPause = trikeElement.querySelector(`#btnPause-${id}`);
  const btnResume = trikeElement.querySelector(`#btnResume-${id}`);

  if (!trike.isRunning) {
    btnStart.disabled = false;
    btnPause.disabled = true;
    btnResume.disabled = true;
  } else {
    btnStart.disabled = true;
    if (trike.isPaused) {
      btnPause.disabled = true;
      btnResume.disabled = false;
    } else {
      btnPause.disabled = false;
      btnResume.disabled = true;
    }
  }
}

function iniciarListenersFirebase() {
  for (let i = 1; i <= TRIKES_TOTAL; i++) {
    const trikeRef = database.ref(`trikes/${i}`);

    trikeRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const trike = trikes[i - 1];

      // Atualiza estado local
      trike.timeLeft = data.timeLeft || 0;
      trike.isRunning = data.isRunning || false;
      trike.isPaused = data.isPaused || false;
      trike.discount = data.discount || 0;
      trike.paymentStatus = data.paymentStatus || 'nao_pago';
      trike.value = data.value || 0;
      trike.finalValue = data.finalValue || 0;

      // Atualiza UI
      const trikeElement = document.getElementById(`trike-${i}`);
      if (!trikeElement) return;

      trikeElement.querySelector(`#timeRemaining-${i}`).textContent = formatTime(trike.timeLeft);
      trikeElement.querySelector(`#discount-${i}`).value = trike.discount;
      trikeElement.querySelector(`#paymentStatus-${i}`).value = trike.paymentStatus;
      trikeElement.querySelector(`#currentValue-${i}`).textContent = trike.value.toFixed(2);
      trikeElement.querySelector(`#currentDiscount-${i}`).textContent = trike.discount.toFixed(2);
      trikeElement.querySelector(`#finalValue-${i}`).textContent = trike.finalValue.toFixed(2);

      const statusEl = trikeElement.querySelector(`#currentPaymentStatus-${i}`);
      if (trike.paymentStatus === 'pago') {
        statusEl.textContent = 'Pago';
        statusEl.classList.add('status-paid');
        statusEl.classList.remove('status-notpaid');
      } else {
        statusEl.textContent = 'Não Pago';
        statusEl.classList.add('status-notpaid');
        statusEl.classList.remove('status-paid');
      }

      updateTrikeUI(i);

      // Gerenciar timers locais
      if (trike.timer) clearInterval(trike.timer);
      if (trike.isRunning && !trike.isPaused && trike.timeLeft > 0) {
        iniciarContagem(i);
      }
    });
  }
}

function gerarRelatorio() {
  const tbody = document.getElementById('relatorioBody');
  tbody.innerHTML = '';
  for (let i = 0; i < TRIKES_TOTAL; i++) {
    const trike = trikes[i];
    const tempoUsadoSeg = (parseInt(document.getElementById(`customTime-${trike.id}`).value) * 60) - trike.timeLeft;
    const tempoUsadoFormatado = formatTime(tempoUsadoSeg < 0 ? 0 : tempoUsadoSeg);
    const pago = trike.paymentStatus === 'pago' ? 'Sim' : 'Não';
    const desconto = trike.discount.toFixed(2);
    const valorFinal = trike.finalValue.toFixed(2);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${trike.id}</td>
      <td>${tempoUsadoFormatado}</td>
      <td>${pago}</td>
      <td>R$ ${desconto}</td>
      <td>R$ ${valorFinal}</td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById('relatorio').style.display = 'block';
}

window.onload = () => {
  // Criar trikes e UI
  for (let i = 1; i <= TRIKES_TOTAL; i++) {
    const trikeObj = criarTrikeObjeto(i);
    trikes.push(trikeObj);
    criarUITrike(trikeObj);
  }
  iniciarListenersFirebase();

  document.getElementById('btnShowReport').addEventListener('click', gerarRelatorio);
};
</script>

</body>
</html>
